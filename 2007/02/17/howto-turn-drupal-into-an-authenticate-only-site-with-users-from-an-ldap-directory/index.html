<!DOCTYPE html>



<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <link rel="openid.server" href="http://openid.yubico.com/server.php" />
  <link rel="openid.delegate" href="http://openid.yubico.com/server.php/idpage?user=vvbdkthjbecc" />

   <title>HOWTO turn Drupal into an authenticate-only site with users from an LDAP directory.</title>
   <meta name="author" content="Bèr ‘berkes’ Kessels" />
   <link href="http://feeds.feedburner.com/berkes" rel="alternate" title="HOWTO turn Drupal into an authenticate-only site with users from an LDAP directory. Feed" type="application/atom+xml" />
   <link rel="author" href="/humans.txt" type="text/plain" />
   <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
   <!-- Included CSS Files -->
   <link rel='stylesheet' type='text/css' href='/bundles/66bfe58a92310a729441d3ebeed7faf2.css' />


   <!--[if lt IE 9]>
   <link rel='stylesheet' type='text/css' href='/bundles/5bf927c3c4faac96d17903f7ba5b378a.css' />

   <![endif]-->

   <script type='text/javascript' src='/bundles/2f42e0e43641f260414dd4eb0161fb9d.js'></script>


   <!-- IE Fix for HTML5 Tags -->
   <!--[if lt IE 9]>
   <script type='text/javascript' src='/bundles/69431f1ec831bacf31013dff2872cba0.js'></script>

   <![endif]-->
</head>
<body>
	<!-- container -->
	<div class="container">
    <header>
      <div class="row">
        <a href="/" title="Home">
          <img src="/assets//images/logo.png" alt="Logo" title="Bèr ‘berkes’ Kessels" />
        </a>
      </div>

      <nav id="main" class="row">
        <div class="onion">
        <ul>
          <li>
          <a href="/about.html">EN / About</a>
          </li>
          <li>
          <a href="/archive.html">EN / Articles</a>
          </li>
          <li>
          <a href="/over.html">NL / Over</a>
          </li>
          <li>
          <a href="/archief.html">NL / Artikelen</a>
          </li>
        </ul>
        </div>
      </nav>
    </header>
    <section id="main-content" class="row">
      <article>
  <header>
    <h1>HOWTO turn Drupal into an authenticate-only site with users from an LDAP directory.</h1>
  </header> 
  <div class="body">
    <p>Drupal has a fantastic feature, the <a href="http://api.drupal.org/api/5/function/hook_auth">hook_auth</a> to allow any third party to interact in the authentication process. This is used to authenticate against other Drupal sites over XMLRPC, it is used in the experimental openID integration, to allow authentication against any database, and so on.
And off course to authenticate against an <a href="http://drupal.org/project/ldap_integration">LDAP directory, using the ldapauth module</a>. This HOWTO helps you on the track for the LDAP coupling.
We use ldapauth.module, userprotect.module and Sympal Password Hijack to mould our Drupal site into an authenticate-only site.</p>

<p><img src="http://webschuur.com/sites/webschuur.com/files/example_ldap_directory.png" alt="Screenshot of LAT, an LDAP managament tool" /></p>

<h2>Contents and disclaimer</h2>

<p>This HOWTO overs the basics of the configuration of LDAP server, and it covers how to configure Drupal to allow authentication. It does not cover any profile data integration with LDAP, nor does it cover group-based, or levelled access control. A user authenticated trough LDAP is an 'authenticated' Drupal user. Nothing more, nothing less.
Be aware that I am no authority on LDAP servers, LDAP schemes or Drupal authentication. Also be aware that I wrote this howto for <em>Drupal 4.7</em>, using the modules available in February 2007, by the time you read this, things may have changed drastically.</p>

<h2>LDAP server</h2>

<p>LDAP is a database server, often used to store people and their login credentials. You can use any server, but this howto will cover the surface of <a href="http://www.openldap.org/">openLDAP</a>, the free and open LDAP server. Getting an LDAP server running is easy (depending on the environment off course), but configuring it properly is not. This howto assumes you have a running Debian system (for experiments with such a server, I advice the excellent <a href="http://www.linode.com/">VPS service Linode</a>). For other servers, distributions and variations, I collected a series of useful <a href="http://www.simpy.com/user/berkes/search/LDAP++tags:" title="howto">LDAP server HOWTOS and manuals on Simpy</a>.</p>

<h2>LDAP scheme</h2>

<p>Because there is not One LDAP structure (unlike, e.g. openID, or DrupalID, whom are standardised) the login-data can live anywhere in the database, on any kind of place, in any kind of form.
This howto describes how to use the popular and standardised <a href="http://www.faqs.org/rfcs/rfc2307.html">NIS scheme</a>, but it could potentially be used for any scheme, including the popular openDirectory by Microsoft.
The NIS scheme is used often as a way to manage users on a Unix system, it has classes such as homeDirectory and LoginShell. Because this scheme is used primarily to contain login-data, most (administrative) clients and applications will be able to use this data.
In addition we can use the inetOrgPerson scheme, which is the de-facto standard to contain addressbook data. This is not required for Drupals authentication, but it is useful for future extension with actual user-data.</p>

<h2>LDAP management</h2>

<p>This howto does not cover how to manage your LDAP users trough Drupal. In fact, it assumes you have third party tools to manage them.</p>

<h2>Performance</h2>

<p>LDAP performs much better then MySQL when it comes to read-only actions, which is what we do in this howto. So, one would expect Drupal with LDAP authentication  to perform a lot better then Drupal with normal authentication. This is not the case. In contrary. Both the architecture of Drupal core, and the LDAP authentication module make it perform a lot worse. Drupal has to write to the MySQL database anyway for any remotely authenticated user. So instead of only the read and write to MySQL that 'normal' authentication does, LDAP authentication performs a read and write to MySQL, <em>in addition to</em> the LDAP read action. And that read action on itself is not performed very optimized either, by the PHP.</p>

<p>So don't go looking at LDAP authentication for performance solutions.</p>

<h2>Get the server up and running</h2>

<p>First we install the openLDAP server slapd</p>

<pre><code># apt-get-install slapd
</code></pre>

<p>Now follow the steps on your screen carefully. None of the choices matter for Drupal authentication, they only make the LDAP work :).
We don't need TLS encryption for local authentication, so if your Drupal site is running on the same server, don't bother about all the TLS stuff. But if you are going to run the authentication over the internet, on different servers, you will have to check out <a href="http://www.debian-administration.org/articles/284">how to make Certificates</a> (not trivial) and how to get <a href="http://www.openldap.org/doc/admin23/security.html#Network%20Security">LDAP to run on the secure connections</a>. Debians configuration includes most of this already, in fact you only need to change /etc/default/slapd, uncomment the SLAPD_SERVICES parameter.</p>

<h2>Configuring the LDAP data schemes</h2>

<p>The Debian package comes with a series of <a href="http://www.zytrax.com/books/ldap/ape/">predefined schemes</a>. No need to change anything there, they offer far more features then we will ever need. If there are things you miss in any of the schemes, you will need <a href="http://www.redhat.com/docs/manuals/dir-server/schema/7.1/server.html">to override them</a>, it is considered bad practice to fiddle with the schemes themselves. This however, is far beyond the scope of this Howto.</p>

<h2>Configuring access schemes</h2>

<p>The LDAP authentication module uses a separate user with search rights to find the user for authentication. We need to give this user full read rights. (backup the configuration first!)</p>

<pre><code># vim /etc/LDAP/slapd.conf

# The admin dn has full write access,
# User has full write access 
# (not required by Drupal, though)
# Everyone in the branch AdminUsers can write and read 
# (not required by Drupal, though)
# Everyone in the branch search (group) can read all entries
# everyone else can only authenticate, never read anything.

access to *
    by dn="cn=admin,dc=LDAP,dc=example,dc=com" write
    by self write
    by dn.children="cn=AdminUsers,dc=LDAP,dc=example,dc=com" write
    by dn.children="cn=search,dc=LDAP,dc=example,dc=com" read
    by anonymous auth
</code></pre>

<h2>Insert the users and branches</h2>

<p>A good alternative for the commandline examples below is using the Gnome LDAP administration tool <a href="http://dev.mmgsecurity.com/projects/lat/">LAT</a>, or the KDE tool <a href="http://www.kde-apps.org/content/show.php?content=9771">Luma</a>. There are probably good GUI tools for <a href="http://freshmeat.net/search/?q=LDAP&amp;section=projects&amp;Go.x=0&amp;Go.y=0">other platforms too</a>.</p>

<p>First we must create the branches mentioned in the configuration. For that, the simplest is to insert them using the LDIF examples that are attached to this howto (A bug in Drupal running this site adds a .txt extension, make sure to rename the files to .ldif after downloading). The admin user, created by Debians installation system, has full rights, so it is the easiest to use that user for inserting the data.</p>

<pre><code>$ ldapadd -c -a -x -D 
\ "cn=admin,dc=LDAP,dc=example,dc=com" -w Y0urP@sswd \
-H ldap://localhost -f file.ldif
</code></pre>

<p>Before we insert this, however, we must create a password for the search user. <a href="http://www.yolinux.com/TUTORIALS/LinuxTutorialLDAP-BindPW.html">Yolinux has a detailed manual on this</a>, but for the searcher the following command will do (on one line!):</p>

<pre><code>$  perl -e 'print("userPassword: {CRYPT}".
crypt("thePassw0rd","salt-n-pepa")."\n");'
</code></pre>

<p>The result must be copied into the <em>userPassword:</em> space in the <em>user_search.ldif</em> file</p>

<p>Upload the files to the server (<em>scp /home/me/*.ldif me@example.com:/home/me/</em> for example).
Then invoke the ldapadd command listed above to insert the files one a time, in the following order:</p>

<ul>
<li> group_AdminUsers.ldif</li>
<li> group_people.ldif</li>
<li> group_search.ldif</li>
<li> user_search.ldif (remember to insert the password here first!)</li>
</ul>


<p><strong>Note of caution:</strong> The searchers password is stored in plaintext in your database, be very sure that you have the access in slapd.conf limited very well for this user.</p>

<h2>Configure Drupal</h2>

<p>Assuming you have a running and installed Drupal, you must now install the ldapauth module. It is found in the <a href="http://drupal.org/project/ldap_integration">LDAP_integration project</a>.</p>

<p>Browse to <em>http://example.com/admin/settings/user</em> and switch off public registrations, because it would defeat the whole purpose of LDAP authentication if people can create their own accounts and gain access that way. The option to choose is 'Only site administrators can create new accounts'.</p>

<h2>Configure LDAPauth module</h2>

<p>Browse to <em>http://example.com/admin/settings/ldapauth</em> and insert the following values:</p>

<ul>
<li>Organisation Name: Any Name You Want (freeform)</li>
<li>LDAP server: localhost (or ldap.example.com)</li>
<li>LDAP port: 389</li>
<li>Use TLS encryption: OFF</li>
<li><p>Store passwords in encrypted form: OFF (as far as I am aware openLDAP has troubles with this setting being on. Please leave a comment if you have more information)</p></li>
<li><p>Do not store users' passwords during sessions: ON (we don't use ldapdata, only ldapauth)</p></li>
<li>When Loggin in, Drupal will look up for the user on: LDAP directory only</li>
<li>Base DNs: cn=people,dc=LDAP,dc=example,dc=com</li>
<li><p>UserName attribute: cn (that way users log in with their 'real name'. In fact I did not get ldapauth to recognise any other attribute then cn)</p></li>
<li><p>DN for non-anonymous search: cn=searcher searcher,cn=search,dc=LDAP,dc=example,dc=com</p></li>
<li>Password: thePassw0rd, as inserted in the <em>perl -e ... );</em> line.</li>
</ul>


<h2>Create one (or more) users in your LDAP 'people' branch.</h2>

<p>Use the same method as adding the searcher user to add me (user_ber.ldif). Including the password generation.</p>

<h2>Check if the LDAP server works and finds the new user.</h2>

<pre><code>$ ldapsearch -x \
-D "cn=searcher searcher,cn=search,dc=LDAP,dc=example,dc=com"\
-w _thePassw0rd_ \
-b "cn=searcher searcher,cn=search,dc=LDAP,dc=example,dc=com"\
-H ldap://localhost "sn=Kes*"
</code></pre>

<h2>Log in with 'ber'</h2>

<p>Browse to your login-page (logout first :) ) and use the username 'Ber Kessels' and the password yo gave that user.</p>

<h2>Restrict changes and edits.</h2>

<p>Because we cannot write to the LDAP directory the site should never allow people changing their data. This is unfortunately hardwired into Drupal, so it can be done, but not very clean (the edit tab will always remain visible, for example).
Install the <a href="http://drupal.org/project/userprotect">User Protect</a> Module by <a href="http://apartmentlines.com/">Chad Phillips</a>
And browse to <em>http://example.com/admin/settings/userprotect/protected_roles</em> Where you should disable all the options for 'authenticated user' by checking the row for that role.
Under access control at <em>http://example.com/admin/access</em> you must deny access for authenticated user to 'change own mail' and 'change own password'.
Especially the e-mail part is important, since ldapauth does not come with an e-mail address. This will cause errors for that user. Another nasty <s>bug</s><a href="http://drupal.org/node/20846">hardcoded feature</a> in Drupal.</p>

<h2>Restrict New Password mails.</h2>

<p>Because we don't have an e-mailaddress, we want to get rid of the hardcoded 'request new password' feature in Drupal. Since this is hardcoded, we cannot simply disable it. Therefore we install the <a href="http://drupal.org/project/sympal_password_hijack">Sympal Password Hijack</a>
This module was especially developed for <a href="http://webschuur.com/portfolio/modules/portfolio/modules_3">this purpose</a>. It allows you to have the password requests mailed to yourself, instead of the user. That way you can edit the LDAP directory entry by hand in case of a lost password.</p>

<h2>Credits</h2>

<p>Thanks to the fine folks at #LDAP on irc.freenode.org for helping me out with the openLDAP configuration
Thanks to the <a href="http://www.tmlzorg.nl/">Thuiszorg Midden-Limburg</a> IT department for sponsoring this document.
Feel free to <a href="/about/contact">contact</a> me if you need LDAP configuration in Drupal done for you.</p>

<p>Update: 17/02/07 changed the settings into a list</p>

  </div>
  <footer>
    <p class="note">
    
      <em>This article was published on webschuur.com. And migrated to this blog. </em>
    
    </p>
    <time datetime="2007-02-17T00:00:00+01:00"
    pubdate="pubdate">
      Posted on 17 February 2007
    </time>
    in
    
    
      
      


  
    
      <a href="/tags.html#php-ref" class="black radius label">php<span class="size">41</span></a>
    
      <a href="/tags.html#drupal-ref" class="black radius label">drupal<span class="size">214</span></a>
    
      <a href="/tags.html#drupal hosting-ref" class="black radius label">drupal hosting<span class="size">11</span></a>
    
      <a href="/tags.html#drupal-ref" class="black radius label">drupal<span class="size">214</span></a>
    
  



    
  </footer>
</article>

<div id="author">
  <p>
  
  
    <strong>About  the author:</strong> Bèr Kessels is an experienced webdeveloper  with a great passion for
    technology and Open Source. A golden combination to implement that technology in a good and efficient
    way. Follow <a href="https://twitter.com/berkes">@berkes</a> on Twitter. Or read more <a href="/over.html">about Bèr</a>.
  
  </p>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'berkes'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<hr/>
<aside>
  
  
  <h1>Read on:</h1>
  
  <ul>
    
      <li><span>February  4, 2014</span> &raquo; <a href="/2014/02/04/new-post">new post</a></li>

    
      <li><span>November 28, 2013</span> &raquo; <a href="/2013/11/28/olaf-van-den-heuvel-is-een-maximum-flapdrol">Olaf van den Heuvel is een maximum flapdrol</a></li>

    
      <li><span>November 27, 2013</span> &raquo; <a href="/2013/11/27/hoe-kom-ik-aan-bitcoin-en-een-bitcoin-rekening">Hoe kom ik aan Bitcoin, en een Bitcoin rekening?</a></li>

    
  </ul>
</aside>


    </section>

    <footer class="main row">
      <div class="contact four columns">
        <p>
            Bèr ‘berkes’ Kessels<br />
            Bèr Kessels is an Open Source Webdeveloper.<br />
            <a href='mailto:ber@berk.es'>ber@berk.es</a>
          </p>
          <p>
            <a href="http://github.com/berkes/">github.com/berkes</a><br />
            <a href="http://twitter.com/berkes/">twitter.com/berkes</a><br />
          </p>
      </div>
      <div class="four columns">
        Copyright 2001-2014
        with a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribute-Share-alike 3.0 Unported license</a>
      </div>
      <div class="four columns">
        <a class="extra" href="/archive.html">Archive (All English articles)</a> <br />
        <a class="extra" href="/archief.html">Archief (Alle Nederlandse artikelen)</a> <br />
        <a class="extra" href="/tags.html">Tags</a> <br />
        <a href="http://feeds.feedburner.com/berkes"> RSS </a> <br />
      </div>
    </footer>
  </div>
  <!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.webschuur.com/" : "http://piwik.webschuur.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 9);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://piwik.webschuur.com/piwik.php?idsite=9" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</body>
</html>
