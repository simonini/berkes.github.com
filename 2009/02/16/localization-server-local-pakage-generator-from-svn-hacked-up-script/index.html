<!DOCTYPE html>



<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <link rel="openid.server" href="http://www.myopenid.com/server" />
  <link rel="openid.delegate" href="http://berkes.myopenid.com/" />
  <link rel="openid2.local_id" href="http://berkes.myopenid.com" />
  <link rel="openid2.provider" href="http://www.myopenid.com/server" />
  <meta http-equiv="X-XRDS-Location" content="http://www.myopenid.com/xrds?username=berkes.myopenid.com" />

   <title>Localization server local pakage generator from SVN (hacked up script)</title>
   <meta name="author" content="Bèr ‘berkes’ Kessels" />
   <link href="http://feeds.feedburner.com/berkes" rel="alternate" title="Localization server local pakage generator from SVN (hacked up script) Feed" type="application/atom+xml" />
   <link rel="author" href="/humans.txt" type="text/plain" />
   <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
   <!-- Included CSS Files -->
   <link rel='stylesheet' type='text/css' href='/bundles/66bfe58a92310a729441d3ebeed7faf2.css' />


   <!--[if lt IE 9]>
   <link rel='stylesheet' type='text/css' href='/bundles/5bf927c3c4faac96d17903f7ba5b378a.css' />

   <![endif]-->

   <script type='text/javascript' src='/bundles/2f42e0e43641f260414dd4eb0161fb9d.js'></script>


   <!-- IE Fix for HTML5 Tags -->
   <!--[if lt IE 9]>
   <script type='text/javascript' src='/bundles/69431f1ec831bacf31013dff2872cba0.js'></script>

   <![endif]-->
</head>
<body>
	<!-- container -->
	<div class="container">
    <header>
      <div class="row">
        <a href="/" title="Home">
          <img src="/assets//images/logo.png" alt="Logo" title="Bèr ‘berkes’ Kessels" />
        </a>
      </div>

      <nav id="main" class="row">
        <div class="onion">
        <ul>
          <li>
          <a href="/about.html">EN / About</a>
          </li>
          <li>
          <a href="/archive.html">EN / Articles</a>
          </li>
          <li>
          <a href="/over.html">NL / Over</a>
          </li>
          <li>
          <a href="/archief.html">NL / Artikelen</a>
          </li>
        </ul>
        </div>
      </nav>
    </header>
    <section id="main-content" class="row">
      <article>
  <header>
    <h1>Localization server local pakage generator from SVN (hacked up script)</h1>
  </header> 
  <div class="body">
    <p>Unless I missed a feature entirely, <a href="http://drupal.org/project/l10n_server">Drupal Localization Server</a> does not really allow packages from external sources to be parsed in its "local package connector". It only eats tarballs with the exact names as they are released from Drupal.org. For example <em>tagadelic-5.x-1.2.tar.gz</em> and nothing else. Well, off course the 5.x-1.2 can vary.</p>

<p>I therefore hacked up an ugly script that we run in a cron to grab our REL-5.x-1.1 from our SVN. Our subversion repository-layout is rather hardcoded in the script, but since it is not that exotic, it should be easy to change it. This script runs over a loca working copy of our SVN and grabs the tags (aka SVN releases) and then tarballs them with the filenames that the local package connector will recognise.</p>

<!--break-->


<pre><code>&lt;?php

ini_set('display_errors', 'stdout');
error_reporting(E_ALL);
init();

//Settings
function l10n_releaser_settings($setting = '') {
  $settings = array(
    'svn_working_copy' =&gt; '/e/ap/tools.ncrv.nl/data/l10n/vibe-repos/', //include trailing slash.
    'tarballs_location' =&gt; '/e/ap/tools.ncrv.nl/data/l10n/', //include trailing slash.
  );

  if (isset($settings[$setting])) {
    return $settings[$setting];
  }
  else {
    return $settings;
  }
}

//svn up working copy
function l10n_releaser_update_working_copy() {
  exec('svn update '. escapeshellarg(l10n_releaser_settings('svn_working_copy')), $output);
  return $output;
}

//loop trough all tags
function l10n_releaser_find_tags() {
  $tags = array();
  $svn_working_copy = l10n_releaser_settings('svn_working_copy');
  $pattern = $svn_working_copy . '*/tags/*';
  foreach (glob($pattern, GLOB_ONLYDIR) as $release) {
    $preg_pattern = "@($svn_working_copy)([^/]*)/tags/REL-(.*)@";
    preg_match($preg_pattern, $release, $matches);
    if (count($matches) &gt;= 3) {
      $tag-&gt;module = $matches[2];
      $tag-&gt;release_tag = $matches[3];
      $tag-&gt;from_dir = $matches[0];
      $tag-&gt;tarball_fragment = $matches[2] .'-'. $matches[3];

      $tags[] = $tag;
    }
  }
  return $tags;
}

//see if the tarball for that tag already exists
function l10n_releaser_tarball_released($tarball_fragment) {
  $path = l10n_releaser_settings('tarballs_location');

  if (file_exists($path . $tarball_fragment .'.tar.gz')) {
    return TRUE;
  }
  else {
    return FALSE;
  }
}

//if no, create it
function l10n_releaser_create_tarball($tarball_fragment, $from_dir, $simulate = FALSE) {
  $dir = l10n_releaser_settings('tarballs_location');

  $command = 'tar -czf '. $dir . $tarball_fragment .'.tar.gz '. escapeshellarg($from_dir);

  if ($simulate) {
    print "\n\t$command\n";
  }
  else {
    print "creating tarball $tarball_fragment\n";
    exec($command, $output);
  }
  return $output;
}

//Do it!
function init() {
  l10n_releaser_update_working_copy();
  foreach (l10n_releaser_find_tags() as $release) {
    if (!l10n_releaser_tarball_released($release-&gt;tarball_fragment)) {
      print l10n_releaser_create_tarball($release-&gt;tarball_fragment, $release-&gt;from_dir);
    }
  }
}
?&gt;
</code></pre>

  </div>
  <footer>
    <p class="note">
    
      <em>This article was published on webschuur.com. And migrated to this blog. </em>
    
    </p>
    <time datetime="2009-02-16T00:00:00+01:00"
    pubdate="pubdate">
      Posted on 16 February 2009
    </time>
    in
    
    
      
      


  
    
      <a href="/tags.html#project management-ref" class="black radius label">project management<span class="size">28</span></a>
    
      <a href="/tags.html#tips and tricks-ref" class="black radius label">tips and tricks<span class="size">23</span></a>
    
      <a href="/tags.html#drupal-ref" class="black radius label">drupal<span class="size">214</span></a>
    
      <a href="/tags.html#drupal-ref" class="black radius label">drupal<span class="size">214</span></a>
    
  



    
  </footer>
</article>

<div id="author">
  <p>
  
  
    <strong>About  the author:</strong> Bèr Kessels is an experienced webdeveloper  with a great passion for
    technology and Open Source. A golden combination to implement that technology in a good and efficient
    way. Follow <a href="https://twitter.com/berkes">@berkes</a> on Twitter. Or read more <a href="/over.html">about Bèr</a>.
  
  </p>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'berkes'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>


    </section>

    <footer class="main row">
      <div class="contact four columns">
        <p>
            Bèr ‘berkes’ Kessels<br />
            Bèr Kessels is an Open Source Webdeveloper.<br />
            <a href='mailto:ber@berk.es'>ber@berk.es</a>
          </p>
          <p>
            <a href="http://github.com/berkes/">github.com/berkes</a><br />
            <a href="http://twitter.com/berkes/">twitter.com/berkes</a><br />
          </p>
      </div>
      <div class="four columns">
        Copyright 2001-2013
        with a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Atrribute-Share-alike 3.0 Unported license</a>
      </div>
      <div class="four columns">
        <a class="extra" href="/archive.html">Archive (All English articles)</a> <br />
        <a class="extra" href="/archief.html">Archief (Alle Nederlandse artikelen)</a> <br />
        <a class="extra" href="/tags.html">Tags</a> <br />
        <a href="http://feeds.feedburner.com/berkes"> RSS </a> <br />
      </div>
    </footer>
  </div>
  <!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.webschuur.com/" : "http://piwik.webschuur.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 9);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://piwik.webschuur.com/piwik.php?idsite=9" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</body>
</html>
