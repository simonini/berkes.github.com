<!DOCTYPE html>



<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <link rel="openid.server" href="http://openid.yubico.com/server.php" />
  <link rel="openid.delegate" href="http://openid.yubico.com/server.php/idpage?user=vvbdkthjbecc" />

   <title>Drupal Imagecache security vulnarability with DDOS attack explained</title>
   <meta name="author" content="Bèr ‘berkes’ Kessels" />
   <link href="http://feeds.feedburner.com/berkes" rel="alternate" title="Drupal Imagecache security vulnarability with DDOS attack explained Feed" type="application/atom+xml" />
   <link rel="author" href="/humans.txt" type="text/plain" />
   <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
   <!-- Included CSS Files -->
   <link rel='stylesheet' type='text/css' href='/bundles/66bfe58a92310a729441d3ebeed7faf2.css' />


   <!--[if lt IE 9]>
   <link rel='stylesheet' type='text/css' href='/bundles/5bf927c3c4faac96d17903f7ba5b378a.css' />

   <![endif]-->

   <script type='text/javascript' src='/bundles/2f42e0e43641f260414dd4eb0161fb9d.js'></script>


   <!-- IE Fix for HTML5 Tags -->
   <!--[if lt IE 9]>
   <script type='text/javascript' src='/bundles/69431f1ec831bacf31013dff2872cba0.js'></script>

   <![endif]-->
</head>
<body>
	<!-- container -->
	<div class="container">
    <header>
      <div class="row">
        <a href="/" title="Home">
          <img src="/assets//images/logo.png" alt="Logo" title="Bèr ‘berkes’ Kessels" />
        </a>
      </div>

      <nav id="main" class="row">
        <div class="onion">
        <ul>
          <li>
          <a href="/about.html">EN / About</a>
          </li>
          <li>
          <a href="/archive.html">EN / Articles</a>
          </li>
          <li>
          <a href="/over.html">NL / Over</a>
          </li>
          <li>
          <a href="/archief.html">NL / Artikelen</a>
          </li>
        </ul>
        </div>
      </nav>
    </header>
    <section id="main-content" class="row">
      <article>
  <header>
    <h1>Drupal Imagecache security vulnarability with DDOS attack explained</h1>
  </header> 
  <div class="body content">
    <p>Nearly a year ago, long before I decided to move out of <a href="http://berk.es/2012/10/01/farewell-drupal/">Drupalwork
entirely</a>, I reported a security vulnarability in Drupal 7 core
in imagecache. Since imagecache is used on most Drupal6 instances this
problem occurs there too. I had the draft for this poste, tucked away on
an offline disk (security-details should not live "online" or in "the
cloud", ever); and, obviously, the day I arrive in Thailand for a
vacation, Drupal released the CVE.</p>

<p>I made a proof of concept, and a tool to test it. A screencast explaining the issue is found below:</p>

<iframe width="420" height="315" src="http://www.youtube.com/embed/JP7Q4co0shk" frameborder="0" allowfullscreen></iframe>


<p>The issue itself is really simple, the solution is hard; because
Imagecache was designed "wrong" in the first place. Let me explain.</p>

<p>You have really basic Drupal7-site on http://example.com, with content-type story that has an image-field. Using three
imagecache-styles: "medium", "large" and "thumbnail".</p>

<p>Imagecache works by creating new images from an original, on demand,
when a particular url is requested:</p>

<pre><code>&amp;lt;img src="http://example.com/sites/default/files/styles/medium/public/field/image/news.jpg" /&amp;gt;
</code></pre>

<p>Dissecting that url, we see:</p>

<ul>
<li>http://example.com/sites/default/files/ is where uploaded files are
stored. This can also be something like http://acme.com/sites/acme-is-evil.org/files/ in case of multisite.</li>
<li>/styles/ is the directory where imageges are cahed under.</li>
<li>/medium/ is the style applied to this image</li>
<li>/public/ the "driver", usually either "private" or "public".</li>
<li>/field/image/news.jpg where the image is stored. The original can
therefore be found at http://example.com/sites/default/files/field/image/news.jpg</li>
</ul>


<p>In this case, a <em>derivative</em> called <em>medium</em> is created. Because creating images
is heavy, they are stored on disk, so a next time, the webserver can
serve this image right-away.</p>

<p>Let me repeat that: Because <em>creating images is heavy</em>, they are <em>stored
on disk</em>.</p>

<p>The idea is as simple as it is wrong: The first time (when the image is created) a full Drupal is booted up,
that Drupal-instance applies the various image-manipulations you have configured
for that style, and then serves and saves the image.</p>

<p>"But why is that Wrong?", you ask?</p>

<p>Because you never know when the <em>heavy stuff</em> will be invoked. It is
unpredictable.</p>

<p>And because the <em>heavy stuff</em> is initialized by your visitors. People from
the evil, outside world. They can fire up your image-creating just by
visiting urls.</p>

<h2>DDOS</h2>

<p>This is a typical DDOS vector: making a server do heavy stuff by
throwing something at it from outside. Typically in an orchestrated
attack that involves many people from many places throwing stuff at it.</p>

<h2>The actual issues: mixing images and styles</h2>

<p>Everything above is not a large problem, because 90%, or more, of the
images used in img-tags on your site, are already created and cached on
disk. An attacker will need to find the last 10% and request these urls.
This is limited.</p>

<p>But, there are more, far more, possible images then those you use in the
img-tags.</p>

<p>We have two images. A frontpage-banner and a user-avatar. They are
<em>usually</em> used with two imagecache styles:</p>

<pre><code>http://example.com/sites/default/files/styles/avatar-thumb/public/users/123.jpg
http://example.com/sites/default/files/styles/front-banner/public/field/image/fancy_banner.png
</code></pre>

<p>I could just swap the styles and create a front-banner from the user-avatar,
and an avatar from the banner, like so:</p>

<pre><code>http://example.com/sites/default/files/styles/front-banner/public/users/user_123.jpg
http://example.com/sites/default/files/styles/avatar-thumb/public/field/image/fancy_banner.png
</code></pre>

<p>And what is worse, you can pull any image in your <em>files</em> directory through imagecache. Including that huge 7MB hi-res upload you forgot there. And if you consider the fact the tool imagemagick (often used as engine to convert the images) can actually handle pdfs, html and many other files you probaly have lying around in your <em>files</em> directory, you know how much your system can be hurt.</p>

<p>This all gets worse with the size of the images that can be abused and
the heavyness of the imagecache-styles you have defined. Adding
watermarks, smartcropping, overlays, rounded corners and whatnot make
the generation of a derivative much heavier then merely resizing an image.</p>

<h2>The other issue: recursiveness</h2>

<p>When we look above, we can see that imagecache will gladly pick up any
file, pull it trough the image-profiles you have defined, using the toolkits at hand and then <em>write out a file to disk</em>.</p>

<p>Guess where? Yup, in the <em>files</em> directory. Adding another file that can
be pulled trough imagecache. So, you can imagecache-already-imagecached
files. [insert inception jokes here].</p>

<p>This is where the attackers have the opportunity to fill up your
servers' harddrive. By simply generating image-styles by mixing up
images and styles, you can create a huge amount of unexpected images.
You them pull these trough imagecache again, to duplicate that huge
amount. And again. And again. Untill urls grow so large that the
webserver refuses them. Apache's limit lies around 4000 characters.</p>

<p>A site with only one, 0.1MB image image and two styles can gain several thousand
directories, nearly fivehundred copies of imagecache derivatives making
a total of ~50MB of new images. All an attacker needs to do, is send 500
HEAD requests to your server, doable in a fraction of a second.</p>

<p>A site with thousands of images and five imagecache styles will get
terabytes of new images in mere minutes. Obviously depending on the
speed of the server and how many (HEAD) requests the server allows simultaniously.
Or in days. Doing only a few-hundred requests each day, yet filling up
your disk slowly but surely, after which your average server will either
start crashing, or your hoster will send you large bills for extra
storage and so on.</p>

<p>Also note that one does not need to download the to-be-generated file. Just requesting it,
with a HEAD is enough.</p>

<h2>The proof of concept tool</h2>

<p>Find it <a href="https://github.com/berkes/canhaz">on github</a>.</p>

<p>Please note that the tool is made for investigative use only; but be
aware that others might not heed this notice and either build such a
tool themselves (it is really simple) or use it to bring down your site.</p>

<p>Because of this, I chose to cripple it a little. The tool cannot detect wether you have applied the
security patch or not, or if you have different measures in place.
Because of this, I have removed the crawling and parrallel part too, limiting it to
images and imagecache-styles found on the page you insert manually.</p>

<p>The tool was made to investigate when and how a system would crash or
choke using these attacks. Please investigate and learn about the CMS
and the modules you are you are using.</p>

<p>Prepare your system for Ruby.</p>

<pre><code>$ sudo apt-get install ruby rubygems #OSX and most Linuxes already have these
$ sudo gem install bundle
</code></pre>

<p>Clone the tool and install the dependencies.</p>

<pre><code>$ git clone https://github.com/berkes/canhaz.git
$ cd canhaz
$ bundle install
</code></pre>

<p>Run!</p>

<pre><code>$ ./canhaz # Shows all tasks
$ canhaz hit http://example.com 20 # generates max 20 imagecache
                                   # derivatives, by investigating
                                   # example.com
</code></pre>

<h2>Lessons learned</h2>

<p>Don't do on-demand generation of things that require heavy work. In this
case, derivatives needed for a user-avatar should be created when a user
uploads that avatar. Even better is to let a <a href="http://en.wikipedia.org/wiki/Thread_pool_pattern">worker queue</a> deal with the actual generation, that way dedicated machines can deal with the heavy lifting,
and users don't have to wait in front of a loading page while you are
making images. For PHP the standard tool
<a href="http://www.php.net/manual/en/book.gearman.php">Gearman</a>, has worked
well for me; just don't expect it to be like resqueue, sidekiq or pythons RQ (yet).</p>

<p>Magic "handyness" like allowing any image to be "imagecached" is
usefull in development, but not in production. So, on your development
environment, you may want imagecached images to be generated on the fly (and probably not
cached, damn you, drush cc-all), you certainly don't want this
flexibility on a production server. You probably want to call some build
task while deploying to re-generated all your images there. Once. Before
deploying.</p>

<p>And for Drupal8: get rid of imagecache and implement a much simpler
on-submit image-builder. It should create the derivatives for when
a File is created and passes validations. This not only solves any such "unpredictable load"
issues, it allows for much easier CDNs, static-file-servers, caching and
more. The on-demand architecture has too much downsides to warrant the
only upside: flexibility.</p>

    <figure>
  <img src="/images//2013/03/04/drupal-imagecache-security-vulnarability-with-ddos-attack-explained.png" alt="Woodcut from Doré. Purely illustrative" />
  
    <figcaption>Doré Woodcut. Its only function is to make the layout look better. And these images are really nice themselves</figcaption>
  
</figure>

  </div>
  <footer>
    <time datetime="2013-03-04T00:00:00+01:00"
    pubdate="pubdate">
      Posted on 04 March 2013
    </time>
    in
    
    
      
      


  
    
      <a href="/tags.html#drupal-ref" class="black radius label">drupal<span class="size">214</span></a>
    
      <a href="/tags.html#imagecache-ref" class="black radius label">imagecache<span class="size">1</span></a>
    
      <a href="/tags.html#security-ref" class="black radius label">security<span class="size">5</span></a>
    
      <a href="/tags.html#ddos-ref" class="black radius label">ddos<span class="size">1</span></a>
    
  



    
  </footer>
</article>

<div id="author">
  <p>
  
  
    <strong>About  the author:</strong> Bèr Kessels is an experienced webdeveloper  with a great passion for
    technology and Open Source. A golden combination to implement that technology in a good and efficient
    way. Follow <a href="https://twitter.com/berkes">@berkes</a> on Twitter. Or read more <a href="/over.html">about Bèr</a>.
  
  </p>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'berkes'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<hr/>
<aside>
  
  
  <h1>Read on:</h1>
  
  <ul>
    
      <li><span>February  4, 2014</span> &raquo; <a href="/2014/02/04/new-post">new post</a></li>

    
      <li><span>November 28, 2013</span> &raquo; <a href="/2013/11/28/olaf-van-den-heuvel-is-een-maximum-flapdrol">Olaf van den Heuvel is een maximum flapdrol</a></li>

    
      <li><span>November 27, 2013</span> &raquo; <a href="/2013/11/27/hoe-kom-ik-aan-bitcoin-en-een-bitcoin-rekening">Hoe kom ik aan Bitcoin, en een Bitcoin rekening?</a></li>

    
  </ul>
</aside>


    </section>

    <footer class="main row">
      <div class="contact four columns">
        <p>
            Bèr ‘berkes’ Kessels<br />
            Bèr Kessels is an Open Source Webdeveloper.<br />
            <a href='mailto:ber@berk.es'>ber@berk.es</a>
          </p>
          <p>
            <a href="http://github.com/berkes/">github.com/berkes</a><br />
            <a href="http://twitter.com/berkes/">twitter.com/berkes</a><br />
          </p>
      </div>
      <div class="four columns">
        Copyright 2001-2014
        with a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribute-Share-alike 3.0 Unported license</a>
      </div>
      <div class="four columns">
        <a class="extra" href="/archive.html">Archive (All English articles)</a> <br />
        <a class="extra" href="/archief.html">Archief (Alle Nederlandse artikelen)</a> <br />
        <a class="extra" href="/tags.html">Tags</a> <br />
        <a href="http://feeds.feedburner.com/berkes"> RSS </a> <br />
      </div>
    </footer>
  </div>
  <!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.webschuur.com/" : "http://piwik.webschuur.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 9);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://piwik.webschuur.com/piwik.php?idsite=9" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</body>
</html>
