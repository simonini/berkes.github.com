<!DOCTYPE html>



<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />

  <!-- Set the viewport width to device width for mobile -->
  <meta name="viewport" content="width=device-width" />
  <link rel="openid.server" href="http://openid.yubico.com/server.php" />
  <link rel="openid.delegate" href="http://openid.yubico.com/server.php/idpage?user=vvbdkthjbecc" />

   <title>When FactoryGirl leads to bad habits</title>
   <meta name="author" content="Bèr ‘berkes’ Kessels" />
   <link href="http://feeds.feedburner.com/berkes" rel="alternate" title="When FactoryGirl leads to bad habits Feed" type="application/atom+xml" />
   <link rel="author" href="/humans.txt" type="text/plain" />
   <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
   <!-- Included CSS Files -->
   <link rel="stylesheet" href="/assets//stylesheets/foundation.css">
   <link rel="stylesheet" href="/assets//stylesheets/pygments.css">
   <link rel="stylesheet" href="/assets//stylesheets/app.css">

   <!--[if lt IE 9]>
   <link rel="stylesheet" href="/assets//stylesheets/ie.css">
   <![endif]-->

   <script src="/assets//javascripts/modernizr.foundation.js"></script>

   <!-- IE Fix for HTML5 Tags -->
   <!--[if lt IE 9]>
     <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
   <![endif]-->

   <!-- Fonts -->
   <link href='http://fonts.googleapis.com/css?family=Arvo:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
   <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=OFL+Sorts+Mill+Goudy+TT" media="screen, projection, print">
</head>
<body>
	<!-- container -->
	<div class="container">
    <header>
      <div class="row">
        <a href="/" title="Home">
          <img src="/assets//images/logo.png" alt="Logo" title="Bèr ‘berkes’ Kessels" />
        </a>
      </div>

      <nav id="main" class="row">
        <div class="onion">
        <ul>
          <li>
          <a href="/about.html">EN / About</a>
          </li>
          <li>
          <a href="/archive.html">EN / Articles</a>
          </li>
          <li>
          <a href="/over.html">NL / Over</a>
          </li>
          <li>
          <a href="/archief.html">NL / Artikelen</a>
          </li>
        </ul>
        </div>
      </nav>
    </header>
    <section id="main-content" class="row">
      <article>
  <header>
    <h1>When FactoryGirl leads to bad habits</h1>
  </header> 
  <div class="body row">
    <div class="eight columns">
      <p><a href="https://github.com/thoughtbot/factory_girl">FactoryGirl</a> is a solution for cleaning up the repetitive task of
setting up test data, used in many Rails projects.</p>

<p>I think FactoryGirl encourages bad design by hiding design problems.</p>

<p>The need for repetitive or complex test-data is an indication that your code and its API need improvement. Instead of improving the application, FactoryGirl enables you to only improve this in your test suite: that is not fixing at all, it is hiding the problem.</p>

<h2>Building up a state before we can test</h2>

<p>We have an app that measures fuel-usage. The feature, or integration test for inserting a
"measurement" could be something like this, when not using FactoryGirl, we can immediately see a problem: (the testing framework is irrelevant here, so I am using RSpec to minimize the noise because it allows me to be concise)</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">scenario</span><span class="p">:</span> <span class="s1">&#39;secretary on a project with cars adds new fuel-usage entries and sees them&#39;</span> <span class="k">do</span>
  <span class="n">project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;new bridge in sahara&#39;</span><span class="p">,</span> <span class="ss">starts_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">beginning_of_year</span><span class="p">,</span> <span class="ss">ends_on</span><span class="p">:</span> <span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="o">.</span><span class="n">end_of_year</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;speedy-joe@example.com&#39;</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="ss">password_confirmation</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">)</span>
  <span class="n">user</span><span class="o">.</span><span class="n">roles</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;secretary&#39;</span><span class="p">,</span> <span class="ss">on</span><span class="p">:</span> <span class="n">project</span><span class="p">)</span>
  <span class="no">Resource</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">type</span><span class="p">:</span> <span class="ss">:car</span><span class="p">,</span> <span class="ss">slug</span><span class="p">:</span> <span class="s1">&#39;13-37-42&#39;</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Joes Truck&#39;</span><span class="p">,</span> <span class="ss">project</span><span class="p">:</span> <span class="n">project</span><span class="p">)</span>
  <span class="n">sign_in</span> <span class="n">user</span>

  <span class="n">visit</span><span class="p">(</span><span class="s2">&quot;projects/</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/resources/</span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/entries/new&quot;</span><span class="p">)</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Measurement&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span>
  <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Measurement&#39;</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="si">}</span><span class="s2">: 12 liter&quot;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>If you consider that only the last four lines are relevant for this
test,the first block is just noisy set-up. Now, we could refactor this
into a before-block in RSpec. Or into a helper method
<code>create_project_with_secretary_and_car</code>. But that is what FactoryGirl
does for us, with a much nicer interface then such ad-hoc helpers. With FactoryGirl
the test could look like:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">scenario</span><span class="p">:</span> <span class="s1">&#39;secretary on a project with cars adds new fuel-usage entries and sees them&#39;</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user_on_project</span><span class="p">,</span> <span class="ss">role_name</span><span class="p">:</span> <span class="s1">&#39;secretary&#39;</span><span class="p">)</span>
  <span class="n">create</span><span class="p">(</span><span class="ss">:car</span><span class="p">,</span> <span class="ss">project</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
  <span class="n">sign_in</span> <span class="n">user</span>

  <span class="n">visit</span><span class="p">(</span><span class="s2">&quot;projects/</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/resources/</span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/entries/new&quot;</span><span class="p">)</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Measurement&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span>
  <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Measurement&#39;</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="si">}</span><span class="s2">: 12 liter&quot;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>The first benefit becomes clear because we see far fewer lines of irrelevant objects being created.
The second benefit of FactoryGirl immediately becomes clear too: we no longer need to provide irrelevant attributes such as the project name.</p>

<p>We have, however not fixed the our application, the implementation is still clumsy; our applications API is still unfriendly. A rake task, an "import"-job, a REST-client still needs to walk through (or consider the state of) all the other records.</p>

<p>If you consider your tests to be one (important) user of your API, a client, the problem is clear: we need to fix the application, not the client using that API.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="ss">scenario</span><span class="p">:</span> <span class="s1">&#39;secretary on a project with cars adds new fuel-usage entries and sees them&#39;</span> <span class="k">do</span>
  <span class="n">resource</span> <span class="o">=</span> <span class="no">Car</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Joes Truck&#39;</span><span class="p">)</span>
  <span class="n">project</span> <span class="o">=</span> <span class="no">Project</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;New Bridge&#39;</span><span class="p">,</span> <span class="ss">resources</span><span class="p">:</span> <span class="o">[</span><span class="n">resource</span><span class="o">]</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">Secretary</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;speedy-joe@example.com&#39;</span><span class="p">,</span> <span class="ss">password</span><span class="p">:</span> <span class="s1">&#39;secret&#39;</span><span class="p">,</span> <span class="ss">project</span><span class="p">:</span> <span class="n">project</span><span class="p">)</span>
  <span class="n">sign_in</span> <span class="n">user</span>

  <span class="n">visit</span><span class="p">(</span><span class="s2">&quot;projects/</span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/resources/</span><span class="si">#{</span><span class="n">car</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/entries/new&quot;</span><span class="p">)</span>
  <span class="n">fill_in</span><span class="p">(</span><span class="s1">&#39;Measurement&#39;</span><span class="p">,</span> <span class="ss">with</span><span class="p">:</span> <span class="mi">12</span><span class="p">)</span>
  <span class="n">click_button</span><span class="p">(</span><span class="s1">&#39;Create Measurement&#39;</span><span class="p">)</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Date</span><span class="o">.</span><span class="n">today</span><span class="si">}</span><span class="s2">: 12 liter&quot;</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>We have added code to our application that is used by one of the
clients: the tests. We have abstracted some of the details away: a
client does not need to know how we have implemented roles. For
example: we can use <code>Car</code> to build a resource, which takes care of
creating a slug, and setting other defaults. If, instead we created some
"car" trait in FactoryGirl, that effort was "wasted" on our app. Worse:
we still maintain knowledge about how "resource" deals with cars in our
test suite. That knowledge is merely centralised in a FactoryGirl file,
but still lives in the client: the tests-suite. Again worse: if your
trait happens to be "helpful" and create a <code>Project</code> too, the factories
become unpredictable. I've spent many hours debugging tests only to find
out that some factory "helpfully" created its own relations: leaving me
with "why the hell are there three Projects, all in a different state, when I thought I created only one?"</p>

<p>As with any good API-design, you want your clients to remain as dumb as possible. You certainly don't want a client having to know how projects, roles, users, resources and so on are related to one another.</p>

<p>In the last example, we have improved our application. Introduced useful defaults, additional, useful models all of which are immediately used by at least one
user of the code: the tests.</p>

<p>Other users can start using these <code>Secretary</code> or <code>Car</code> models and the automatic defaults on <code>Projects</code> too, now. They allow us to clean up code that used the clumsy interface: controllers, rake-tasks, async-workers and so on.</p>

<p>Quite often, I've found that by removing the usage of a
<code>FactoryGirl.create</code> in a test, I could improve not only the code under
test, but a lot of other places in the application too: Suddenly you
realize that the "case param[:resource_type]" in your controller can be
completely removed and replaced with a few smart calls to <code>Car.new</code> and
<code>Boat.new</code> and so on. It even, quite often, resulted in improvements of
the UX: by setting sane defaults, instead of presenting the user with a
"starts on is a required field" we save it and set a default. All this
because we learned from our tests that the code had some issues. All
this we would not have learned if instead we cleaned up the tests with
FactoryGirl.</p>

<h2>Unit testing</h2>

<p>I'd argue that with Unit tests there is even more reason not to use
FactoryGirl. I often go as far as to forbid the usage of FactoryGirl
in unit-tests.</p>

<p>First of all, there is the "unit" part of the unit test: A test for
Role, applies to Role alone. If you, somehow need to store a User with
every Role, in order to test that Role, you have tightly coupled code.
When your Role cannot live without a User (or Vice Versa), you don't have
a <code>Role</code> and a <code>User</code>, but a <code>UserWithRole</code> unit. Since we want
decoupled code (we want decoupled code, don't we?) getting into this
mess is something to avoid. FactoryGirl does not help you to avoid this,
it even encourages this design somewhat:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">&#39;#function&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;includes the name of the role and its project&#39;</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:secretary_on_project</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;Secretary for New Bridge&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nf">function</span>
    <span class="n">roles</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">r</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>This looks like a nice, clean test. But only because we have hidden away
all the complexity of coming to a state in which the user has a role and
a project and both have a name. And because the test looks nice and clean, we might think we
are done. We are not: One line of code with four issues (and
probably actual bugs):</p>

<ul>
<li>It cannot deal with a user that has no roles.</li>
<li>It cannot deal with a user with roles which have no project.</li>
<li>It will render strange texts when a role or a project has no name.</li>
<li>The User is dealing with attributes on roles, and even attributes on
that roles' attributes (Law of Demeter).</li>
</ul>


<blockquote><p>Sidenote: a method like <code>function</code> should, IMO not be part of the Model,
but is presentation and should either live in the views, or in some
decorator or presentation double <code>UserPrester</code>. For the sake of the
example, let's leave it here, just note that our tests are telling us
this too: we are creating a presentable name in an object that deals
wit details wit database-state: we are violating the Single
Responsibility Principle.</p></blockquote>

<p>When I recently encountered several of these exact issues in one of my projects' codebase, the developers argued that the
solution was to add more "validation". "Yea, but our models
require a role and each role requires a project. And we are only
rendering stored users, so this should never happen".</p>

<p>It will happen, when you render the unstored role back on the screen when there validation-issues on storing the
user, or its role. Or when deleting a project and not dealing correctly with deleting the associated roles and users.</p>

<p>When you test with a clean, predefined set of test-data, you won't notice all such edge cases. But when you test with the simplest and most extreme edge case: an unstored, empty <code>User</code>, most, if not all, these problems will be avoided; in the design, rather then in validations, delete-hooks, checking-for-nil in views and so on.</p>

<p>If we had tested without FactoryGirl, it would have looked something
like this:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">&#39;#function&#39;</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span> <span class="c1"># In RSpec, this is returned when using the method &#39;subject&#39;</span>
  <span class="n">context</span> <span class="s1">&#39;when user has roles&#39;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="o">[</span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Secretary&#39;</span><span class="p">)</span><span class="o">]</span> <span class="p">}</span>
    <span class="n">it</span> <span class="s1">&#39;includes the name of the role&#39;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;Secretary&#39;</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">&#39;when role has project&#39;</span> <span class="k">do</span>
      <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="o">[</span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Secretary&#39;</span><span class="p">,</span> <span class="ss">project</span><span class="p">:</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;New Bridge&#39;</span><span class="p">))</span><span class="o">]</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s1">&#39;includes the name of the project&#39;</span> <span class="k">do</span>
        <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;New Bridge&#39;</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">context</span> <span class="s1">&#39;when user has no roles&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;is &quot;no function&quot;&#39;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;no function&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>Now our tests tell us about the problems:</p>

<ul>
<li>We explicitly have to deal with the situation when a user has no roles.</li>
<li>We see clearly that the "function" is reaching too deep, through roles
into the project.</li>
</ul>


<p>Because it is made clear, we can now fix that:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">describe</span> <span class="s1">&#39;#function&#39;</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s1">&#39;when user has roles&#39;</span> <span class="k">do</span>
    <span class="n">before</span> <span class="p">{</span> <span class="n">subject</span><span class="o">.</span><span class="n">roles</span> <span class="o">=</span> <span class="o">[</span><span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">as_function</span><span class="p">:</span> <span class="s1">&#39;Secretary on New Bridge&#39;</span><span class="p">)</span><span class="o">]</span> <span class="p">}</span>
      <span class="n">it</span> <span class="s1">&#39;includes role as a function&#39;</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;Secretary on New Bridge&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">context</span> <span class="s1">&#39;when user has no roles&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="o">.</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">be</span> <span class="s1">&#39;no function&#39;</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>The tests are clean, and explain very well how we deal with edge cases.
Because we have minimized the issues appearing in edge cases and because
we have delegated the methods to the right objects.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nf">function</span>
    <span class="k">return</span> <span class="s1">&#39;no function&#39;</span> <span class="k">unless</span> <span class="n">roles</span>
    <span class="n">roles</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="ss">:as_function</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">class</span> <span class="nc">Role</span>
  <span class="k">def</span> <span class="nf">as_function</span>
    <span class="k">return</span> <span class="s1">&#39;no project&#39;</span> <span class="k">unless</span> <span class="n">project</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">project</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>We have now clearly improved our code, not just the tests. Bonus: since we no
longer have to store stuff in the database, our unit-test is much faster now.</p>

<blockquote><p>Sidenote: <code>subject.roles = [Struct.new]</code> or <code>subject.roles =
[double(:role)]</code> is a way of mocking the <code>Role</code>: a User, nor its
unit-test, needs to know how 'Role' exactly works, making that
explicitly clear in a test is often considered a good practice. Yet
mocking and stubbing itself has a lot of downsides too. That is beyond
this post. One important thing, though: this code, when using
ActiveRecord Relations, will not work, since AR does not allow <code>roles</code>
to be assigned anything other then a list of <code>Roles</code>: passing in a
double or Struct will cause an exception. I use <code>mock_model()</code> to fix
this.</p></blockquote>

<p>Whether you consider a controller a unit and test it as such, or whether
you test it in a more "integration" makes little difference for the
usage of FactoryGirl. A controller <a href="http://mixandgo.com/blog/how-to-test-controllers-in-rails">tested as
unit</a>, has no
interaction with the database at all: so it really needs no FactoryGirl.
When you test a controller and let it go through the database, that
database needs state. But the above "feature test" examples apply here
even more: if a certain controller action needs a lot of records
in the database before it "can work", the problem lies there, not in
your tests which create all these records.</p>

<h2>Don't hide problems, fix them.</h2>

<p>FactoryGirl is a solution for hiding problems with your application and
its API. When a test tells you that the API is clumsy, or dirty, instead
of fixing that API, FactoryGirl encourages you to hide this problem.</p>

<p>I'd argue that when some test needs 20+ records created before it can
run, it is far better to leave these 20+ lines of code creating these
records in your tests. At least you then admit and document the problem
you have. Refactoring them with FactoryGirl makes it appear as if there
is no problem with your application code. This is even more true for
unit-tests that use FactoryGirl.</p>

<h2>When to use FactoryGirl?</h2>

<p>Is it completely useless and should you never use it then? No, it has a
very good usecase: when your API does demand complex state, or lots of
repetitive attributes. When your <code>Order</code> requires a <code>ShippingAddress</code>, it is poor
practice to hide this away in factories. Even more so in the unit-tests
of <code>Order</code>. Instead consider introducing a <code>ShippedOrder</code> model a
'OrderBuilder<code>service-object or an</code>Order.create_with_address()` helper
even. Improve the API of your application.</p>

<p>I also want to give a shout-out to the developers of FactoryGirl: I've
used it with great pleasure to replace Rails core -even more clumsy-
fixtures. Please don't read this as an attack on FactoryGirl and its
developers, it are personal observations on using a "test data framework".</p>

<p>But when Address requires you to type your address over and over in your
tests, then FactoryGirl is a nice DSL to put the "generating a street,
city and postal code" in a central place. After all: generating this, is
part of the task of the client, not the API. FactoryGirl is a fancy
solution for creating such data. But since factorygirl is very tightly
coupled to the database and the models that represent that database, it
is way more.
When you need an "address data" in your tests, you could just as well
add a small helper:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">LoremIzer</span>
  <span class="k">def</span> <span class="nf">address</span>
    <span class="p">{</span> <span class="ss">street</span><span class="p">:</span> <span class="s1">&#39;Diagon Alley&#39;</span><span class="p">,</span>
      <span class="ss">number</span><span class="p">:</span> <span class="s1">&#39;13a&#39;</span><span class="p">,</span>
      <span class="ss">city</span><span class="p">:</span> <span class="s1">&#39;London&#39;</span><span class="p">,</span>
      <span class="ss">postal_code</span><span class="p">:</span> <span class="s1">&#39;1337&#39;</span><span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>It is only when such helpers grow large and wieldy: when they start to
turn into a framework, that FactoryGirl (or another <a href="https://github.com/EmmanuelOga/ffaker">data generation
gem</a> has a good place in your app.</p>

    </div>
    <div class="four columns">
      <figure class="decorative">
  <img src="/images//2015/02/19/when-factorygirl-leads-to-bad-habits.png" alt="Woodcut from Doré. Purely illustrative" />
  
    <figcaption>Doré Woodcut. Its only function is to make the layout look better. And these images are really nice themselves</figcaption>
  
</figure>

    </div>
  </div>
  <footer>
    <time datetime="2015-02-19T00:00:00+01:00"
    pubdate="pubdate">
      Posted on 19 February 2015
    </time>
    in
    
    
      
      


  
    
      <a href="/tags.html#rails-ref" class="black radius label">rails<span class="size">7</span></a>
    
  



    
  </footer>
</article>

<div id="author">
  <p>
  
  
    <strong>About  the author:</strong> Bèr Kessels is an experienced webdeveloper  with a great passion for
    technology and Open Source. A golden combination to implement that technology in a good and efficient
    way. Follow <a href="https://twitter.com/berkes">@berkes</a> on Twitter. Or read more <a href="/over.html">about Bèr</a>.
  
  </p>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'berkes'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<hr/>
<aside>
  
  
  <h1>Read on:</h1>
  
  <ul>
    
      <li><span>April  6, 2016</span> &raquo; <a href="/2016/04/06/simple-time-logging-on-top-of-git-flow">Simple time logging on top of git flow</a></li>

    
      <li><span>December 14, 2015</span> &raquo; <a href="/2015/12/14/beste-nunl-dit-vinden-wij-jammer">Beste Nu.nl. Dit vinden wij jammer.</a></li>

    
      <li><span>May  9, 2015</span> &raquo; <a href="/2015/05/09/add-sorting-to-your-product-page-in-spree">Add sorting to your product page in Spree</a></li>

    
  </ul>
</aside>


    </section>

    <footer class="main row">
      <div class="contact four columns">
        <p>
            Bèr ‘berkes’ Kessels<br />
            Bèr Kessels is an Open Source Webdeveloper.<br />
            <a href='mailto:ber@berk.es'>ber@berk.es</a>
          </p>
          <p>
            <a href="http://github.com/berkes/">github.com/berkes</a><br />
            <a href="http://twitter.com/berkes/">twitter.com/berkes</a><br />
          </p>
      </div>
      <div class="four columns">
        Copyright 2001-2016
        with a
        <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribute-Share-alike 3.0 Unported license</a>
      </div>
      <div class="four columns">
        <a class="extra" href="/archive.html">Archive (All English articles)</a> <br />
        <a class="extra" href="/archief.html">Archief (Alle Nederlandse artikelen)</a> <br />
        <a class="extra" href="/tags.html">Tags</a> <br />
        <a href="http://feeds.feedburner.com/berkes"> RSS </a> <br />
      </div>
    </footer>
  </div>
  <!-- Piwik -->
<script type="text/javascript">
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.webschuur.com/" : "http://piwik.webschuur.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 9);
piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
</script><noscript><p><img src="http://piwik.webschuur.com/piwik.php?idsite=9" style="border:0" alt="" /></p></noscript>
<!-- End Piwik Tracking Code -->

</body>
</html>
